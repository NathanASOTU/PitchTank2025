<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pitch Tank Competition</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="container mx-auto p-4">
  <h1 class="text-3xl font-bold mb-4">Pitch Tank Competition</h1>
  <div class="mb-4">
    <label class="mr-2">Select Room:</label>
    <select id="roomSelect" class="border p-2 rounded">
      <option value="Studio 1">Studio 1</option>
      <option value="Studio 2">Studio 2</option>
      <option value="Studio 3">Studio 3</option>
      <option value="Final">Final</option>
    </select>
  </div>
  <div id="judges" class="mb-6"></div>
  <div id="companies" class="mb-6"></div>
  <div class="mb-6">
    <h2 class="text-2xl font-semibold">Judge Score Entry</h2>
    <form id="judgeForm" class="flex flex-col gap-4 max-w-md">
      <select id="teamName" class="border p-2 rounded"></select>
      <select id="judgeName" class="border p-2 rounded"></select>
      <input id="score" type="number" step="0.1" min="1" max="5" placeholder="Score (1-5)" class="border p-2 rounded">
      <button type="submit" class="bg-blue-500 text-white p-2 rounded">Submit Score</button>
    </form>
  </div>
  <div class="mb-6">
    <h2 class="text-2xl font-semibold">Audience Score Entry</h2>
    <form id="audienceForm" class="flex flex-col gap-4 max-w-md">
      <select id="audienceTeamName" class="border p-2 rounded"></select>
      <input id="audienceScore" type="number" step="0.1" min="1" max="5" placeholder="Audience Score (1-5)" class="border p-2 rounded">
      <button type="submit" class="bg-green-500 text-white p-2 rounded">Submit Audience Score</button>
    </form>
  </div>
  <p id="error" class="text-red-500 hidden"></p>
  <div>
    <h2 class="text-2xl font-semibold">Results</h2>
    <canvas id="resultsChart" width="400" height="200"></canvas>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDRwVHh0r-hpb1Wfa6YdSj4cZRWx9Wl0pM",
      authDomain: "asotu-con-pitch-tank.firebaseapp.com",
      projectId: "asotu-con-pitch-tank",
      storageBucket: "asotu-con-pitch-tank.firebasestorage.app",
      messagingSenderId: "397957008743",
      appId: "1:397957008743:web:919855d25d5e739fb8f3c2"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const rooms = {
      'Studio 1': {
        judges: [
          { name: 'Beth Hill', img: 'https://via.placeholder.com/100?text=Beth' },
          { name: 'Christopher Twohig', img: 'https://via.placeholder.com/100?text=Christopher' },
          { name: 'Chase Fraser', img: 'https://via.placeholder.com/100?text=Chase' }
        ],
        companies: [
          { name: 'Autoz Network LLC', logo: 'https://via.placeholder.com/150?text=Autoz' },
          { name: 'Toma', logo: 'https://via.placeholder.com/150?text=Toma' },
          { name: 'DriveItAway', logo: 'https://via.placeholder.com/150?text=DriveItAway' },
        ],
        teams: ['Team A', 'Team B', 'Team C']
      },
      'Studio 2': {
        judges: [
          { name: 'Ben Hadley', img: 'https://via.placeholder.com/100?text=Ben' },
          { name: 'Patrick Abad', img: 'https://via.placeholder.com/100?text=Patrick' },
          { name: 'Bill Cariss', img: 'https://via.placeholder.com/100?text=Bill' }
        ],
        companies: [
          { name: 'Carmen', logo: 'https://via.placeholder.com/150?text=Carmen' },
          { name: 'Lyteflo', logo: 'https://via.placeholder.com/150?text=Lyteflo' },
          { name: 'Space Auto', logo: 'https://via.placeholder.com/150?text=SpaceAuto' }
        ],
        teams: ['Team D', 'Team E', 'Team F']
      },
      'Studio 3': {
        judges: [
          { name: 'Elizabeth Shults', img: 'https://via.placeholder.com/100?text=Elizabeth' },
          { name: 'Brian Donnelly', img: 'https://via.placeholder.com/100?text=Brian' },
          { name: 'Tony Fowler', img: 'https://via.placeholder.com/100?text=Tony' }
        ],
        companies: [
          { name: 'Fasten Rewards', logo: 'https://via.placeholder.com/150?text=Fasten' },
          { name: 'Mia', logo: 'https://via.placeholder.com/150?text=Mia' },
          { name: 'Autograph Analytics', logo: 'https://via.placeholder.com/150?text=Autograph' }
        ],
        teams: ['Team G', 'Team H', 'Team I']
      },
      'Final': {
        judges: [
          { name: 'Kyle Mountsier', img: 'https://via.placeholder.com/100?text=Kyle' },
          { name: 'Beth Hill', img: 'https://via.placeholder.com/100?text=Beth' },
          { name: 'Chase Fraser', img: 'https://via.placeholder.com/100?text=Chase' },
          { name: 'Bill Cariss', img: 'https://via.placeholder.com/100?text=Bill' },
          { name: 'Brian Donnelly', img: 'https://via.placeholder.com/100?text=Brian' }
        ],
        companies: [],
        teams: ['Finalist 1', 'Finalist 2', 'Finalist 3']
      }
    };

    let scores = {};
    let myChart;

    function renderRoom() {
      const room = document.getElementById('roomSelect').value;
      const judgesDiv = document.getElementById('judges');
      const companiesDiv = document.getElementById('companies');
      const judgeSelect = document.getElementById('judgeName');
      const teamSelect = document.getElementById('teamName');
      const audienceTeamSelect = document.getElementById('audienceTeamName');

      judgesDiv.innerHTML = '<h2 class="text-2xl font-semibold">Judges</h2><div class="flex flex-wrap gap-4">' +
        rooms[room].judges.map(judge =>
          `<div class="text-center"><img src="${judge.img}" alt="${judge.name}" class="w-24 h-24 rounded-full mx-auto"><p>${judge.name}</p></div>`
        ).join('') + '</div>';

      companiesDiv.innerHTML = '<h2 class="text-2xl font-semibold">Companies</h2><div class="flex flex-wrap gap-4">' +
        rooms[room].companies.map(company =>
          `<div class="text-center"><img src="${company.logo}" alt="${company.name}" class="w-32 h-32 mx-auto"><p>${company.name}</p></div>`
        ).join('') + '</div>';

      judgeSelect.innerHTML = '<option value="">Select Judge</option>' +
        rooms[room].judges.map(judge => `<option value="${judge.name}">${judge.name}</option>`).join('');

      teamSelect.innerHTML = '<option value="">Select Team</option>' +
        rooms[room].teams.map(team => `<option value="${team}">${team}</option>`).join('');

      audienceTeamSelect.innerHTML = '<option value="">Select Team</option>' +
        rooms[room].teams.map(team => `<option value="${team}">${team}</option>`).join('');

      renderChart();
    }

    function showError(msg) {
      const error = document.getElementById('error');
      error.textContent = msg;
      error.classList.remove('hidden');
      setTimeout(() => error.classList.add('hidden'), 3000);
    }

    document.getElementById('judgeForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const team = document.getElementById('teamName').value;
      const judge = document.getElementById('judgeName').value;
      const score = parseFloat(document.getElementById('score').value);
      const room = document.getElementById('roomSelect').value;

      if (!team || !judge || !score) return showError('Please fill all fields');
      if (score < 1 || score > 5) return showError('Score must be between 1 and 5');

      db.ref('scores').push({ room, team, judge, score, timestamp: Date.now() });
      document.getElementById('judgeForm').reset();
      document.getElementById('teamName').value = '';
      document.getElementById('judgeName').value = '';
    });

    document.getElementById('audienceForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const team = document.getElementById('audienceTeamName').value;
      const score = parseFloat(document.getElementById('audienceScore').value);
      const room = document.getElementById('roomSelect').value;

      if (!team || !score) return showError('Please fill all fields');
      if (score < 1 || score > 5) return showError('Score must be between 1 and 5');

      db.ref('scores').push({ room, team, judge: 'Audience', score, timestamp: Date.now() });
      document.getElementById('audienceForm').reset();
      document.getElementById('audienceTeamName').value = '';
    });

    db.ref('scores').on('value', (snapshot) => {
      scores = snapshot.val() || {};
      renderChart();
    });

    function renderChart() {
      const room = document.getElementById('roomSelect').value;
      const teamScores = {};
      Object.values(scores).forEach(({ room: r, team, judge, score }) => {
        if (r !== room) return;
        if (!teamScores[team]) teamScores[team] = { judges: [], audience: null };
        if (judge === 'Audience') teamScores[team].audience = score;
        else teamScores[team].judges.push(score);
      });

      const aggregated = {};
      Object.keys(teamScores).forEach(team => {
        const { judges, audience } = teamScores[team];
        const judgeCount = rooms[room].judges.length;
        const judgeAvg = judges.length ? judges.reduce((sum, s) => sum + s, 0) / judges.length : 0;
        const audienceWeight = audience ? audience / judgeCount : 0;
        aggregated[team] = judgeAvg + audienceWeight;
      });

      const ctx = document.getElementById('resultsChart').getContext('2d');
      if (myChart) myChart.destroy();
      myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(aggregated),
          datasets: [{
            label: 'Team Scores',
            data: Object.values(aggregated),
            backgroundColor: 'rgba(75, 192, 192, 0.6)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }]
        },
        options: {
          scales: { y: { beginAtZero: true, max: 10 } },
          plugins: { title: { display: true, text: `Scores for ${room}` } }
        }
      });
    }

    document.getElementById('roomSelect').addEventListener('change', renderRoom);
    renderRoom();
  </script>
</body>
</html>